FROM temporalio/server:1.25.2

RUN awk '/^(archival:|namespaceDefaults:)$/ {found = 1; print; next} found && /^[[:space:]]/ {next} found && !/^[[:space:]]/ {found = 0} 1' /etc/temporal/config/config_template.yaml | sed '/^archival:$/a\  history:\n    state: "{{ default .Env.TEMPORAL_ARCHIVAL_HISTORY_STATE "disabled" }}"\n    enableRead: {{ default .Env.TEMPORAL_ARCHIVAL_HISTORY_ENABLEREAD "true" }}\n    provider:\n      s3store:\n        region: "{{ .Env.TEMPORAL_ARCHIVAL_HISTORY_S3STORE_REGION }}"\n        {{- if .Env.TEMPORAL_ARCHIVAL_HISTORY_S3STORE_ENDPOINT }}\n        endpoint: "{{ .Env.TEMPORAL_ARCHIVAL_HISTORY_S3STORE_ENDPOINT }}"\n        {{- end }}\n        logLevel: {{ default .Env.TEMPORAL_ARCHIVAL_HISTORY_S3STORE_LOGLEVEL "0" }}\n  visibility:\n    state: "{{ default .Env.TEMPORAL_ARCHIVAL_VISIBILITY_STATE "disabled" }}"\n    enableRead: {{ default .Env.TEMPORAL_ARCHIVAL_VISIBILITY_ENABLEREAD "true" }}\n    provider:\n      s3store:\n        region: "{{ .Env.TEMPORAL_ARCHIVAL_VISIBILITY_S3STORE_REGION }}"\n        {{- if .Env.TEMPORAL_ARCHIVAL_VISIBILITY_S3STORE_ENDPOINT }}\n        endpoint: "{{ .Env.TEMPORAL_ARCHIVAL_VISIBILITY_S3STORE_ENDPOINT }}"\n        {{- end }}\n        logLevel: {{ default .Env.TEMPORAL_ARCHIVAL_VISIBILITY_S3STORE_LOGLEVEL "0" }}' | sed '/^namespaceDefaults:$/a\  archival:\n    history:\n      state: "{{ default .Env.TEMPORAL_NAMESPACEDEFAULTS_ARCHIVAL_HISTORY_STATE "disabled" }}"\n      URI: "{{ .Env.TEMPORAL_NAMESPACEDEFAULTS_ARCHIVAL_HISTORY_URI }}"\n    visibility:\n      state: "{{ default .Env.TEMPORAL_NAMESPACEDEFAULTS_ARCHIVAL_VISIBILITY_STATE "disabled" }}"\n      URI: "{{ .Env.TEMPORAL_NAMESPACEDEFAULTS_ARCHIVAL_VISIBILITY_URI }}"' > /etc/temporal/config/tmp_config_template.yaml && mv /etc/temporal/config/tmp_config_template.yaml /etc/temporal/config/config_template.yaml
